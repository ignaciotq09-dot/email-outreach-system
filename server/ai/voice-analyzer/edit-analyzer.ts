import { callOpenAIWithTimeout } from "../openai-client";

export async function analyzeEditPatterns(edits: Array<{ originalText: string; editedText: string; }>): Promise<{ commonRemovals: string[]; commonAdditions: string[]; lengthPreference: "shorter" | "longer" | "same"; formalityAdjustment: number; totalEditsAnalyzed: number; }> {
  if (edits.length === 0) return { commonRemovals: [], commonAdditions: [], lengthPreference: "same", formalityAdjustment: 0, totalEditsAnalyzed: 0 };
  const editPairs = edits.slice(0, 10).map((e, i) => `Edit ${i + 1}:\nBEFORE: ${e.originalText.substring(0, 300)}${e.originalText.length > 300 ? '...' : ''}\nAFTER: ${e.editedText.substring(0, 300)}${e.editedText.length > 300 ? '...' : ''}`).join("\n\n");
  const prompt = `Analyze these email edits made by a user to AI-generated content. Identify patterns in what they consistently change.\n\n${editPairs}\n\nRespond with JSON:\n{\n  "commonRemovals": [<words/phrases the user consistently removes>],\n  "commonAdditions": [<words/phrases the user consistently adds>],\n  "lengthPreference": "<shorter|longer|same - does user make emails shorter or longer?>",\n  "formalityAdjustment": <-5 to +5 - negative means user makes more casual, positive means more formal>,\n  "insights": "<brief description of user's editing patterns>"\n}`;
  try { const response = await callOpenAIWithTimeout([{ role: "system", content: "You are an expert at analyzing writing edits to understand user preferences." }, { role: "user", content: prompt }], { responseFormat: { type: "json_object" }, maxTokens: 600 }); const analysis = JSON.parse(response); return { commonRemovals: analysis.commonRemovals || [], commonAdditions: analysis.commonAdditions || [], lengthPreference: analysis.lengthPreference || "same", formalityAdjustment: Math.max(-5, Math.min(5, analysis.formalityAdjustment || 0)), totalEditsAnalyzed: edits.length }; } catch (error) { console.error("[VoiceAnalyzer] Error analyzing edit patterns:", error); return { commonRemovals: [], commonAdditions: [], lengthPreference: "same", formalityAdjustment: 0, totalEditsAnalyzed: edits.length }; }
}
